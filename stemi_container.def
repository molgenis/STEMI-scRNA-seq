# getting singularity working on mac: https://sylabs.io/guides/3.8/admin-guide/installation.html#installation-on-windows-or-mac
# update container apt-get update && apt-get upgrade
# use yum in apt-get install yum
#Place the following lines into the '.rpmmacros' file:
#%_var /var
#%_dbpath %{_var}/lib/rpm
# add to sudo nano /etc/yum.conf
# assumeyes=1

BootStrap: yum
OSVersion: 7
MirrorURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/$basearch/
Include: yum
%setup

%files

%environment

%runscript


%post
    # commands to be executed inside container during bootstrap
    echo diskspacecheck=0 >> /etc/yum.conf
    mkdir -p /storage/home
    mkdir -p /storage/work
    mkdir -p /gpfs/scratch
    mkdir -p /gpfs/group
    mkdir -p /var/spool/torque
    # install subscription manager
    yum -y install subscription-manager
    # add python and install some packages
    yum -y groups install "Development Tools"
    #yum -y groups install "GNOME Desktop"
    yum -y groups install "Base"
    #yum -y groups install "X Window System" "Desktop" "Fonts"
    yum -y install qt
    yum -y install mesa-libGLU
    yum -y install SDL SDL-devel
    yum -y install epel-release
    yum -y install qtwebkit
    yum -y install qt5-qtbase-devel
    yum -y install gmp-devel
    yum -y install mpfr-devel
    #yum -y install R
    yum -y install postgresql-devel
    # install openssl
    yum -y install openssl-devel
    # install libpng
    yum -y install libpng-devel
    # cairo stuff
    yum -y install libXt-devel
    # install hdf5
    #yum -y install hdf5-devel
    git clone https://github.com/HDFGroup/hdf5.git
    cd hdf5
    #git checkout 820695a78e3a277daea1bdcbb8ad54b8ee6650a5 #commit for 1.12
    git checkout db30c2da68ece4a155e9e50c28ec16d6057509b2 #commit for 1.10
    ./configure --prefix=/usr/local/hdf5
    make
    #make check     # run test suite.
    make install
    #make check-install        # verify installation.
    cd ../
    rm -r hdf5
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/hdf5/lib/
    ln -s /usr/local/hdf5/bin/* /usr/bin/
    ln -s /usr/local/hdf5/include/* /usr/include/
    # tkl needed for nichenet
    yum -y install tcl
    yum -y install tcl-devel
    yum -y install libjpeg*
    # needed for R devtools
    yum -y install libxml2-devel
    ########################
    # install conda #
    ########################
    yum -y install curl
    wget https://repo.anaconda.com/archive/Anaconda3-2019.07-Linux-x86_64.sh
    bash Anaconda3-2019.07-Linux-x86_64.sh -b -p /opt/anaconda3
    ln -s /opt/anaconda3/bind/conda /usr/local/bin/conda
    rm Anaconda3-2019.07-Linux-x86_64.sh
    # install python tools
    /opt/anaconda3/bin/conda config --add channels defaults
    /opt/anaconda3/bin/conda config --add channels bioconda
    /opt/anaconda3/bin/conda config --add channels conda-forge
    /opt/anaconda3/bin/conda create -n scanpyenv scanpy=1.8.1 python=3.7
    /opt/anaconda3/bin/conda create -n scvelo_env scvelo=0.2.3 python=3.7
    /opt/anaconda3/bin/conda create -n scrublet_env scrublet=0.2.3 python=3.7
    /opt/anaconda3/bin/conda init bash
    #########################
    # install java tools    #
    #########################
    yum -y install java-1.8.0-openjdk-devel
    yum -y install java-11-openjdk
    yum -y install maven
    yum -y install git
    git clone https://github.com/molgenis/systemsgenetics.git
    cd ./systemsgenetics
    git checkout 34096bdbaae723d438d9167d962806efeb0b63e1
    # increase memory for maven
    export MAVEN_OPTS="-Xmx4096m -XX:MaxPermSize=4096m"
    # build the projects
    mvn package -DskipTests
    mkdir -p /opt/systemsgenetics/GenotypeHarmonizer/
    cp ./Genotype-Harmonizer/target/GenotypeHarmonizer-1.4.23-SNAPSHOT.jar /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.jar
    echo "#/bin/bash" > /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh
    echo "java -jar /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.jar" >> /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh
    chmod u+x /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh
    ln -s /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh /usr/local/bin/GenotypeHarmonizer.sh
    mkdir -p /opt/systemsgenetics/eqtl-mapping-pipeline/
    cp ./eqtl-mapping-pipeline/target/eqtl-mapping-pipeline-1.4.9a-SNAPSHOT.jar /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.jar
    echo "#/bin/bash" > /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.sh
    echo "java -jar /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.jar" >> /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.sh
    chmod u+x /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.sh
    ln -s /opt/systemsgenetics/eqtl-mapping-pipeline/qtl-mapping-pipeline.sh /usr/local/bin/qtl-mapping-pipeline.sh
    cd ../
    rm -r systemsgenetics
    # install a zip library
    yum -y install bzip2
    # install EPEL for different packages
    yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
    #sudo subscription-manager repos --enable "rhel-*-optional-rpms"
    yum -y install yum-utils
    #sudo yum-config-manager --enable "rhel-*-optional-rpms"
    # install fontconfig
    yum -y install fontconfig
    # install cairo
    yum -y install cairo-devel
    #########################
    # install plink         #
    #########################
    yum -y install unzip
    curl -O https://s3.amazonaws.com/plink1-assets/plink_linux_x86_64_20210606.zip
    mkdir -p /opt/plink
    unzip -o plink_linux_x86_64_20210606.zip -d /opt/plink/
    chmod u+x /opt/plink/plink
    ln -s /opt/plink/plink /usr/local/bin/plink
    rm plink_linux_x86_64_20210606.zip
    curl -O https://s3.amazonaws.com/plink2-assets/plink2_linux_x86_64_20210816.zip
    mkdir -p /opt/plink2
    unzip -o plink2_linux_x86_64_20210816.zip -d /opt/plink2/
    chmod u+x /opt/plink2/plink2
    ln -s /opt/plink2/plink2 /usr/local/bin/plink2
    rm plink2_linux_x86_64_20210816.zip
    #########################
    # install bcftools      #
    #########################
    yum -y install bcftools
    #########################
    # install R             #
    #########################
    export R_VERSION=4.1.0
    curl -O https://cdn.rstudio.com/r/centos-7/pkgs/R-${R_VERSION}-1-1.x86_64.rpm
    yum -y install R-${R_VERSION}-1-1.x86_64.rpm
    ln -s /opt/R/${R_VERSION}/bin/R /usr/local/bin/R
    ln -s /opt/R/${R_VERSION}/bin/Rscript /usr/local/bin/Rscript
    #########################
    # install R libraries   #
    #########################
    # set the repo
    echo 'local({r <- getOption("repos");r["CRAN"] <- "https://mirror.lyrahosting.com/";options(repos = r)})' > ~/Rprofile.site
    # first install biocmanager and remotes
    R --slave -e 'install.packages(c("BiocManager", "remotes"), repos="https://mirror.lyrahosting.com/CRAN/")'
    # some other stuff
    R --slave -e 'BiocManager::install("BiocGenerics")'
    R --slave -e 'BiocManager::install("Biobase")'
    # which allows us to install devtools
    R --slave -e 'remotes::install_version("rversions", "2.1.1", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("roxygen2", "7.1.1", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'BiocManager::install(c("devtools"))'
    # which allows us to install specific versions of software
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/multtest_2.48.0.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("data.table", "1.14.0", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("ggplot2", "3.3.5", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("ggpubr", "0.4.0", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("Matrix", "1.3-4", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("Matrix.utils", "0.9.8", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("metap", "1.4", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("stringr", "1.4.0", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("RColorBrewer", "1.1-2", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("VennDiagram", "1.6.20", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("Rcpp", "1.0.7", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("foreach", "1.5.1", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("doMC", "1.3.7", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("gridExtra", "2.3", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("lattice", "0.20-44", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("plyr", "1.8.6", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("dplyr", "1.0.7", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("UpSetR", "1.4.0", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("scales", "1.1.1", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("broom", "0.7.9", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("tidyverse", "1.3.1", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/MatrixGenerics_1.4.2.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("MatrixEQTL", "2.3", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/S4Vectors_0.30.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/IRanges_2.26.0.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("RCurl", "1.98-1.3", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/data/annotation/src/contrib/GenomeInfoDbData_1.2.6.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/GenomeInfoDb_1.28.1.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/zlibbioc_1.38.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/XVector_0.32.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/GenomicRanges_1.44.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/MatrixGenerics_1.4.1.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("metafor", "3.0-2", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/topconfects_1.8.0.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("plotly", "4.9.4.1", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("htmlwidgets", "1.5.3", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/MetaVolcanoR_1.6.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/Biostrings_2.60.2.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("snow", "0.4-3", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("BH", "1.75.0-0", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/BiocParallel_1.26.1.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/Rhtslib_1.24.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/Rsamtools_2.8.0.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("RSQLite", "2.2.7", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("png", "0.1-7", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/KEGGREST_1.32.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/AnnotationDbi_1.54.1.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("XML", "3.99-0.6", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/GenomicAlignments_1.28.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/BiocIO_1.2.0.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("restfulr", "0.0.13", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/rtracklayer_1.52.1.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/BSgenome_1.60.0.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("filelock", "1.0.2", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/BiocFileCache_2.0.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/biomaRt_2.48.2.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/GenomicFeatures_1.44.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/VariantAnnotation_1.38.0.tar.gz", repos=NULL)'
    #R --slave -e 'remotes::install_version("hdf5r", "1.3.3", repos="https://mirror.lyrahosting.com/CRAN/")'
    #R --slave -e 'remotes::install_version("hdf5r", "1.3.3", repos="https://mirror.lyrahosting.com/CRAN/", build_opts=c("--no-resave-data", "--no-manual", "--no-build-vignettes", "--with-hdf5=/usr/local/hdf5/bin/h5cc"))'
    # this package is a nightmare
    #wget https://cran.r-project.org/src/contrib/Archive/hdf5r/hdf5r_1.3.2.tar.gz
    #R --slave -e 'install.packages("./hdf5r_1.3.2.tar.gz")'
    R --slave -e 'remotes::install_version("hdf5r", "1.3.2", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("Seurat", "4.0.3", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'devtools::install_github("thomasp85/patchwork@v1.1.0")'
    R --slave -e 'devtools::install_github("mojaveazure/seurat-disk", ref="163f1aade5bac38ed1e9e9c912283a7e74781610")'
    R --slave -e 'remotes::install_version("harmony", "0.1.0", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'devtools::install_github("JinmiaoChenLab/Rphenograph", ref="0298487f0ee13aac55eb77d19992f6bd878ba2fc")'
    R --slave -e 'remotes::install_version("systemfonts", "1.0.2", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("svglite", "2.0.0", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("clue", "0.3-59", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("GetoptLong", "1.0.5", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("Cairo", "1.5-12.2", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("circlize", "0.4.13", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'remotes::install_version("doParallel", "1.0.16", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/ComplexHeatmap_2.8.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/DelayedArray_0.18.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/SummarizedExperiment_1.22.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/SingleCellExperiment_1.14.1.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/MAST_1.18.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://www.bioconductor.org/packages/release/bioc/src/contrib/limma_3.48.3.tar.gz", repos=NULL)'
    R --slave -e 'devtools::install_github("sqjin/CellChat", ref="eb959d5fc45df9920116f90644fe0b5e155e304b")'
    R --slave -e 'devtools::install_github("saeyslab/nichenetr", ref="2136a7260fbbe9ef5e9b4af0fd4c9101a3bc9a78")'
    R --slave -e 'install.packages("https://bioconductor.org/packages/release/bioc/src/contrib/KEGGREST_1.32.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://bioconductor.org/packages/release/bioc/src/contrib/AnnotationDbi_1.54.1.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://bioconductor.org/packages/release/bioc/src/contrib/annotate_1.70.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://bioconductor.org/packages/release/bioc/src/contrib/genefilter_1.74.0.tar.gz", repos=NULL)'
    R --slave -e 'remotes::install_version("locfit", "1.5-9.4", repos="https://mirror.lyrahosting.com/CRAN/")'
    R --slave -e 'install.packages("https://bioconductor.org/packages/release/bioc/src/contrib/geneplotter_1.70.0.tar.gz", repos=NULL)'
    R --slave -e 'install.packages("https://bioconductor.org/packages/release/bioc/src/contrib/DESeq2_1.32.0.tar.gz", repos=NULL)'
    R --slave -e 'devtools::install_github("velocyto-team/velocyto.R", ref="83e6ed92c2d9c9640122dcebf8ebbb5788165a21")'
    #R --slave -e 'devtools::install_github("leeshawn/MetaSKAT", ref="c0b63c1961a8d772842d4a5004330d273a8aeb43")'
    #R --slave -e 'devtools::install_github("weizhouUMICH/SAIGE", ref="648850f38ed8f2d187af6a0587cb078fa3233ec6")'
